---
title: "WPGMA or UPGMA?"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{WPGMA or UPGMA?}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, eval = T}
library(compbio4all)
```


## Data matrix

Data matrix from https://en.wikipedia.org/wiki/UPGMA#First_step


```{r}
# The data
#      a   b   c   d   e
a <- c(0,	 17, 21, 31, 23)
b <- c(17, 0,	 30, 34, 21)
c	<- c(21, 30, 0,  28, 39)
d	<- c(31, 34, 28,	0, 43)
e	<- c(23, 21, 39, 43,	0)

# Bind into a matrix
WPGMA.mat1 <- rbind(a,b,c,d,e)

colnames(WPGMA.mat1) <- c("a","b","c","d","e")

diag(WPGMA.mat1) <- NA

WPGMA.mat1[upper.tri(WPGMA.mat1)] <- NA
```

## Data frame to store stuff


```{r}
n.taxa <- nrow(WPGMA.mat1)
WPGMA_output <- data.frame(it = c(1:n.taxa),
                           clust.i = NA,
                           clust.j = NA,
                           dist.ij = NA,
                           clust.u = NA,
                           branch.l.ij = NA)
```


## Algorithm - First step

### Determine minimum value in current matrix

The minimum distance
```{r}
dist.min.i <- min(WPGMA.mat1, na.rm = T)
```

The index values of the minimum
```{r}
index.min.i <- which(WPGMA.mat1 == dist.min.i, arr.ind =T)
index.row.i <- index.min.i[1]
index.col.i <- index.min.i[2]
```

We can get the names of our taxa using the 
```{r}
cluster.i2 <- rownames(WPGMA.mat1)[index.row.i]
cluster.i1 <- colnames(WPGMA.mat1)[index.col.i]
```


Add output to dataframe
```{r}
WPGMA_output[1,"clust.i"] <- cluster.i1
WPGMA_output[1,"clust.j"] <- cluster.i2
WPGMA_output[1,"dist.ij"] <- dist.min.i
```


### Combine species into clade

Combine the two taxa names into a new name.  This can be done a couple ways.
```{r}
clade.i <- paste(cluster.i1,cluster.i2, sep = "")
```

We'll add this to the dataframe
```{r}
WPGMA_output[1,"clust.u"] <- clade.i
```


### First branch length estimation

Branch length is distance/2 or d.ij/2
```{r}
WPGMA_output[1,"branch.l.ij"] <- WPGMA_output[1,"dist.ij"]/2
```


### First distance matrix update - WPGMA version

Distance (ab) to all other points
ab to c
ab to d
ab to e


#### ab to c

```{r}
Ta <- 1
Tb <- 1
Da_c <- 21
Db_c <- 30
Dab_c <- (Ta*Da_c+Tb*Db_c)/2
```



#### ab to d

We now continue for the other distances.  I'll stick to the wikipedia notation for now.

D(ab to d) = [D(a to d) + D(b to d)] / 2
D(ab to d) = [    31    +     34   ] / 2
D(ab to d) = [    31    +     34   ] / 2
D(ab to d) = 32.5

Dab_d      = [Da_d + Db_d] / 2
Dab_d      = 32.5

```{r}
Ta <- 1
Tb <- 1
Da_d <- 31
Db_d <- 34
Dab_d <- (Ta*Da_d+Tb*Db_d)/2
```

#### ab to e


D(ab to d) = [D(a to d) + D(b to d)] / 2
D(ab to d) = [    23    +     21   ] / 2
D(ab to d) = [    23    +     21   ] / 2
D(ab to d) = Dab_e

Dab_d      = [Da_d + Db_d] / 2
Dab_d      = Dab_e

```{r}
Ta <- 1
Tb <- 1
Da_e <- 23
Db_e <- 21
Dab_e <- (Ta*Da_e+Tb*Db_e)/2

```

The distances are
```{r}
Dab_c
Dab_d
Dab_e
```


### Update matrix with new distance

Old matrix has distances  from a and b to all other points: we want to replace these.  distances among c, d, and e are still the same values.

```{r}
WPGMA.mat1
```

#### Illustration


Create smaller matrix with clade ab
```{r}
#       ab      c   d   e
ab  <- c(NA,    NA,  NA, NA)
c	  <- c(Dab_c, NA,  NA, NA)
d	  <- c(Dab_d, 28,	 NA, NA)
e	  <- c(Dab_e, 39,  43, NA)

WPGMA.mat2 <- rbind(ab,c,d,e)
colnames(WPGMA.mat2) <- c("ab","c","d","e")

```




## Algorithm - Second step

We've combined a and b and calculated the disnace of this clade (a,b) to the remaining taxa.  What is now the minimum distance?


The minimum distance of the current matrix
```{r}
dist.min.i <- min(WPGMA.mat2, na.rm = T)
```

The index value of the current minimum
```{r}
index.min.i <- which(WPGMA.mat2 == dist.min.i, arr.ind =T)
index.row.i <- index.min.i[1]
index.col.i <- index.min.i[2]
```

We can get the names of our taxa using the 

```{r}
cluster.i2 <- rownames(WPGMA.mat2)[index.row.i]
cluster.i1 <- colnames(WPGMA.mat2)[index.col.i]
```


Add output to dataframe
```{r}
WPGMA_output[2,"clust.i"] <- cluster.i1
WPGMA_output[2,"clust.j"] <- cluster.i2
WPGMA_output[2,"dist.ij"] <- dist.min.i
```

### Combine species into clade

Combine the two taxa names into a new name.  This can be done a couple ways.
```{r}
clade.i <- paste(cluster.i1,cluster.i2, sep = "")
```

We'll add this to the dataframe

```{r}
WPGMA_output[2,"clust.u"] <- clade.i
```


### Calculate branch length

Branch length is distance/2 or d.ij/2 = d.ab.e = 22/2
```{r}
WPGMA_output[2,"branch.l.ij"] <- WPGMA_output[2,"dist.ij"]/2
```

### Recalculate distance from abe to all remainign taxa

In the current matrix, the smallest distance is between ab and e

We therefore want to form a clade between ab and e (abe), the measure the distance from this clade to allthe other species.


#### abe to c

NOTE: WPGMA doesn't wait by the number of species in the clad, so T.ab = 2, not 1
```{r}
T.ab <- 1 #not 2 as in UPGMA
T.e  <- 1
Dab_c <- 25.5
De_c  <- 39
Dabe_c <- (T.ab*Dab_c + T.e*De_c)/(T.ab+T.e)
```

#### abe to c

For abe to d

```{r}
T.ab <- 1
T.e  <- 1
Dab_d <- 32.5
De_d  <- 43
Dabe_d <- (T.ab*Dab_d + T.e*De_d)/(T.ab+T.e)

```


Distances
```{r}
Dabe_c
Dabe_d
```

### Update the matrix

```{r}
abe <- c(NA,     NA,  NA)
c	   <- c(Dabe_c, NA,  NA)
d	   <- c(Dabe_d, 28,	 NA)


WPGMA.mat3 <- rbind(abe,c,d)
colnames(WPGMA.mat3) <- c("abe","c","d")
```

This matrix is different than the UPGMA matrix.

## Third step

### Calculate branch lengths


The minimum distance of the current matrix
```{r}
dist.min.i <- min(WPGMA.mat3, na.rm = T)
```

The index value of the current minimum
```{r}
index.min.i <- which(WPGMA.mat3 == dist.min.i, arr.ind =T)
index.row.i <- index.min.i[1]
index.col.i <- index.min.i[2]
```

We can get the names of our taxa using the 

```{r}
cluster.i2 <- rownames(WPGMA.mat3)[index.row.i]
cluster.i1 <- colnames(WPGMA.mat3)[index.col.i]
```


Add output to dataframe
```{r}
WPGMA_output[3,"clust.i"] <- cluster.i1
WPGMA_output[3,"clust.j"] <- cluster.i2
WPGMA_output[3,"dist.ij"] <- dist.min.i
```

### Combine species into clade

Combine the two taxa names into a new name.  This can be done a couple ways.
```{r}
clade.i <- "cd"
clade.i <- paste("c","d",sep = "")

clade.i <- paste(cluster.i1,cluster.i2, sep = "")
```

We'll add this to the dataframe

```{r}
WPGMA_output[3,"clust.u"] <- clade.i
```


### Calculate branch length

Branch length is distance/2 or d.ij/2 = d.d.e = 28/2
```{r}
WPGMA_output[3,"branch.l.ij"] <- WPGMA_output[3,"dist.ij"]/2
```




### Distance of c to abe and d to abe

```{r}
T.c  <- 1
T.d  <- 1
Dc_abe <- 32.25
Dd_abe <- 37.75

Ddc_abe <- (T.c*Dc_abe + T.d*Dd_abe)/(T.c+T.d)


```

Create matrix
```{r}
abe <- c(NA,     NA)
cd	 <- c(Ddc_abe, NA)



WPGMA.mat4 <- rbind(abe,cd)
colnames(WPGMA.mat4) <- c("abe","cd")


```

## Finish up

The final entry of the matrix is 35  This means that the distnace from the clade abe to the clade de is 33, with branch length of 35/2 = 17.5

The minimum distance
```{r}
dist.min.i <- min(WPGMA.mat4, na.rm = T)
```

The index value of the minimum
```{r}
index.min.i <- which(WPGMA.mat4 == dist.min.i, arr.ind =T)
index.row.i <- index.min.i[1]
index.col.i <- index.min.i[2]
```

We can get the names of our taxa using the 

```{r}
cluster.i2 <- rownames(WPGMA.mat4)[index.row.i]
cluster.i1 <- colnames(WPGMA.mat4)[index.col.i]
```


Add output to dataframe
```{r}
WPGMA_output[4,"clust.i"] <- cluster.i1
WPGMA_output[4,"clust.j"] <- cluster.i2
WPGMA_output[4,"dist.ij"] <- dist.min.i
```



### Combine species into clade

Combine the two taxa names into a new name.  This can be done a couple ways.
```{r}
clade.i <- paste(cluster.i1,cluster.i2, sep = "")
```

We'll add this to the dataframe

```{r}
WPGMA_output[4,"clust.u"] <- clade.i
```


### Calculate branch length

Branch length is distance/2 or d.ij/2
```{r}
WPGMA_output[4,"branch.l.ij"] <- WPGMA_output[4,"dist.ij"]/2
```



## Plotting



Most of the time we don't include branch lengths in Newick format, but there is a way to do it. You don't need to know how to do this - this is just for illustration

```{r}
full.tree <- "((c:14,d:14):3.5,(e:11,(b:8.5, a:8.5):2.5):6.5);" # semi colon!
full.tree <-ape::read.tree(text=full.tree)
plot(full.tree, main = "")
```


```{r}

```

